# =============================================================================
# AUTONOMOUS ROBOT - DEFAULT CONFIGURATION
# =============================================================================
# Sử dụng file này để chỉnh các tham số mà không cần sửa code
# Copy file này thành robot_config.yaml để customize

# =============================================================================
# CAMERA CONFIGURATION
# =============================================================================
camera:
  width: 640
  height: 480
  fps: 30
  offset_x: 0              # Camera offset from robot center (pixels). Positive = camera right of center
  
  # Frame acquisition settings
  frame_timeout_ms: 1500   # Timeout for frame acquisition (ms)
  warmup_frames: 10        # Number of warmup frames to skip
  max_failures: 5          # Max consecutive failures before restart
  
  # Camera Intrinsic Calibration (from camera_calibration.py)
  # Set to null to use factory calibration
  intrinsic_calibration:
    enabled: false           # Enable custom calibration
    camera_matrix: null      # 3x3 matrix [[fx, 0, cx], [0, fy, cy], [0, 0, 1]]
    distortion_coefficients: null  # [k1, k2, p1, p2, k3] distortion coefficients
    reprojection_error: null # Calibration accuracy (pixels)
  
# Region of Interest - FPV Trapezoid (Tối ưu cho line following)
roi:
  top_left_x: 0.30      # Top left X ratio
  top_right_x: 0.70     # Top right X ratio
  bottom_left_x: 0.10   # Bottom left X ratio  
  bottom_right_x: 0.90  # Bottom right X ratio
  top_y: 0.55           # Top of trapezoid Y ratio (higher = more of road visible)
  bottom_y: 0.95        # Bottom of trapezoid Y ratio

# =============================================================================
# LANE DETECTION
# =============================================================================
lane_detection:
  # Color Thresholds for White Lane
  white_hls_low: [0, 200, 0]
  white_hls_high: [255, 255, 255]
  
  # Color Thresholds for Yellow Lane  
  yellow_hls_low: [15, 100, 100]
  yellow_hls_high: [35, 255, 255]
  
  # Threshold for black lanes on white background
  black_threshold: 80
  
  # Morphological Operations - Tối ưu cho line detection
  morph_kernel_size: 3        # Kernel size (odd number, 3-7 recommended)
  morph_close_iterations: 3   # Fill gaps in line (2-5 recommended)
  morph_open_iterations: 1    # Remove noise
  
  # Canny Edge Detection
  canny_low: 50
  canny_high: 150
  
  # Hough Transform - Tối ưu cho line detection
  hough_rho: 1
  hough_theta_degrees: 1
  hough_threshold: 25
  hough_min_line_length: 50
  hough_max_line_gap: 30
  
  # Lane Clustering (pixel boundaries)
  left_lane_x_min: 0
  left_lane_x_max: 200
  center_lane_x_min: 200
  center_lane_x_max: 440
  right_lane_x_min: 440
  right_lane_x_max: 640
  
  # Fitting
  poly_order: 2
  min_points_for_fit: 10
  look_ahead_distance: 100
  min_lane_confidence: 0.5

# =============================================================================
# OBJECT DETECTION
# =============================================================================
object_detection:
  model_path: "data/models/yolov8n.pt"
  confidence_threshold: 0.5
  nms_threshold: 0.4
  
  # Classes to detect (COCO indices)
  detect_classes:
    0: "person"
    1: "bicycle"
    2: "car"
    3: "motorcycle"
    5: "bus"
    7: "truck"

# =============================================================================
# DEPTH ESTIMATION
# =============================================================================
depth:
  median_filter_size: 3
  min_valid: 0.1        # meters
  max_valid: 10.0       # meters
  
  # Depth Calibration (from depth_calibration.py)
  calibration:
    correction_factor: 1.0  # Multiplicative correction (1.0 = no correction)
    offset: 0.0            # Additive offset in meters (0.0 = no offset)
    enabled: false         # Enable depth correction

# =============================================================================
# OBSTACLE DETECTION
# =============================================================================
obstacle:
  d_safe: 2.0           # Safe distance (meters)
  d_emergency: 0.5      # Emergency stop distance (meters)
  # Lane thresholds (auto-calculated from camera width)
  # left_threshold = camera_width / 3
  # right_threshold = camera_width * 2 / 3

# =============================================================================
# STATE MACHINE
# =============================================================================
state_machine:
  lane_transition_hysteresis: 5    # frames
  obstacle_clear_frames: 10        # frames

# =============================================================================
# MOTION CONTROL
# =============================================================================
motion_control:
  # PID Gains for Steering
  pid:
    kp: 0.005
    ki: 0.0001
    kd: 0.002
    output_min: -1.0
    output_max: 1.0
    integral_limit: 100.0
  
  # Speed Parameters (m/s)
  speed:
    max: 0.8
    min: 0.2
    normal: 0.6
    slow: 0.3
  
  # Curvature thresholds
  curvature:
    high_threshold: 0.01
    low_threshold: 0.001
  
  # Rate Limiting
  max_velocity_change_rate: 0.1    # m/s per cycle
  max_yaw_change_rate: 0.2         # rad/s per cycle

# =============================================================================
# UART / STM32 COMMUNICATION
# =============================================================================
uart:
  port: "/dev/ttyUSB0"
  baudrate: 115200
  bytesize: 8
  parity: "N"
  stopbits: 1
  timeout: 0.1
  command_rate_hz: 10

# =============================================================================
# ROBOT PHYSICAL PARAMETERS
# =============================================================================
robot:
  leg_height: 0.15      # meters

# =============================================================================
# SYSTEM SETTINGS
# =============================================================================
system:
  main_loop_rate_hz: 30
  log_level: "INFO"     # DEBUG, INFO, WARNING, ERROR
